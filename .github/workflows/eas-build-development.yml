# ‚úçÔ∏è Description:
# This workflow is used to trigger a build on EAS for the development environment.
# It will run on every GitHub release published on the repo or can be triggered manually from the actions tab.
# This workflow will use ./actions/eas-build action to trigger the build on EAS with staging env.

# üö® GITHUB SECRETS REQUIRED:
#         - EXPO_TOKEN: Expo token to authenticate with EAS
#         - You can get it from https://expo.dev/settings/access-tokens

name: EAS Development Build (Android & IOS) (EAS)

on:
  repository_dispatch:
    types: [trigger-eas-build-workflow-dev]
  # push:
  #   tags:
  #     - '*-dev' # Matches tags ending with '-dev'

jobs:
  setup:
    name: Setup Common Resources
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ env.PACKAGE_VERSION }}
      run_ios: ${{ env.RUN_IOS }}
      run_android: ${{ env.RUN_ANDROID }}
      should_submit: ${{ env.SHOULD_SUBMIT }}
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN_XRAY_ANALYZER }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi
      - name: üì¶ Checkout project repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set Build Variables
        id: set_build_vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "RUN_IOS=${{ github.event.client_payload.run_ios }}" >> $GITHUB_ENV
            echo "RUN_ANDROID=${{ github.event.client_payload.run_android }}" >> $GITHUB_ENV
            echo "SHOULD_SUBMIT=${{ github.event.client_payload.should_submit }}" >> $GITHUB_ENV
          else
            echo "RUN_IOS=false" >> $GITHUB_ENV
            echo "RUN_ANDROID=true" >> $GITHUB_ENV
            echo "SHOULD_SUBMIT=false" >> $GITHUB_ENV
          fi
      - name: Debug Output
        run: |
          echo "Event Details:"
          echo "  Event name: ${{ github.event_name }}"
          echo "  Event action: ${{ github.event.action }}"
          echo "  Client payload: ${{ toJSON(github.event.client_payload) }}"
          echo "RUN_IOS: ${{ env.RUN_IOS }}"
          echo "RUN_ANDROID: ${{ env.RUN_ANDROID }}"
          echo "SHOULD_SUBMIT: ${{ env.SHOULD_SUBMIT }}"
          echo "PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}"

  ios_build:
    needs: setup
    if: needs.setup.outputs.run_ios == 'true'
    name: iOS Build
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node-pnpm-install

      - name: 'Load environment variables'
        run: |
          # Define the environment file name based on the input environment
          APP_ENV="development"
          ENV_FILE=".env.${APP_ENV}"

          # Create the environment file (use $ENV_FILE variable)
          touch $ENV_FILE

          # Export Google Services JSON secrets to the GitHub environment
          echo "GOOGLE_SERVICES_JSON_ANDROID_BASE64=${{ secrets.GOOGLE_SERVICES_JSON_ANDROID_BASE64 }}" >> $GITHUB_ENV
          echo "GOOGLE_SERVICES_PLIST_IOS_BASE64=${{ secrets.GOOGLE_SERVICES_PLIST_IOS_BASE64 }}" >> $GITHUB_ENV

          # Append environment variables to the defined env file
          echo "GOOGLE_SERVICES_JSON_PATH=${{ vars.GOOGLE_SERVICES_JSON_PATH }}" >> $ENV_FILE
          echo "GOOGLE_SERVICES_PLIST_PATH=${{ vars.GOOGLE_SERVICES_PLIST_PATH }}" >> $ENV_FILE
          echo "ANTHROPIC_API_KEY=${{secrets.ANTHROPIC_API_KEY}}" >> $ENV_FILE
          echo "RESEND_API_KEY=${{secrets.RESEND_API_KEY}}" >> $ENV_FILE
          echo "RESEND_SENDER_EMAIL=${{secrets.RESEND_SENDER_EMAIL}}" >> $ENV_FILE
          echo "RESEND_SENDER_EMAIL=${{secrets.TEST_ACCOUNT}}" >> $ENV_FILE

      - name: üßë‚Äçüíª Decode google services
        run: pnpm run decode-google-services

      - name: ‚è±Ô∏è EAS Build iOS
        uses: ./.github/actions/eas-build
        with:
          APP_ENV: development
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN_XRAY_ANALYZER }}
          VERSION: ${{ env.PACKAGE_VERSION }}
          FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS }}
          FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          CREDENTIAL_FILE_CONTENT_GOOGLE_KEY: ${{ secrets.FIREBASE_DISTRIBUTION_CREDENTIAL_FILE_CONTENT}}
          ANDROID: false
          IOS: true
          SHOULD_SUBMIT: ${{ needs.setup.outputs.should_submit }}

  android_build:
    needs: setup
    if: needs.setup.outputs.run_android == 'true'
    name: Android Build
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node-pnpm-install

      - name: 'Load environment variables'
        run: |
          # Define the environment file name based on the input environment
          APP_ENV="development"
          ENV_FILE=".env.${APP_ENV}"

          # Create the environment file (use $ENV_FILE variable)
          touch $ENV_FILE

          # Export Google Services JSON secrets to the GitHub environment
          echo "GOOGLE_SERVICES_JSON_ANDROID_BASE64=${{ secrets.GOOGLE_SERVICES_JSON_ANDROID_BASE64 }}" >> $GITHUB_ENV
          echo "GOOGLE_SERVICES_PLIST_IOS_BASE64=${{ secrets.GOOGLE_SERVICES_PLIST_IOS_BASE64 }}" >> $GITHUB_ENV

          # Append environment variables to the defined env file
          echo "GOOGLE_SERVICES_JSON_PATH=${{ vars.GOOGLE_SERVICES_JSON_PATH }}" >> $ENV_FILE
          echo "GOOGLE_SERVICES_PLIST_PATH=${{ vars.GOOGLE_SERVICES_PLIST_PATH }}" >> $ENV_FILE
          echo "ANTHROPIC_API_KEY=${{secrets.ANTHROPIC_API_KEY}}" >> $ENV_FILE
          echo "RESEND_API_KEY=${{secrets.RESEND_API_KEY}}" >> $ENV_FILE
          echo "RESEND_SENDER_EMAIL=${{secrets.RESEND_SENDER_EMAIL}}" >> $ENV_FILE
          echo "RESEND_SENDER_EMAIL=${{secrets.TEST_ACCOUNT}}" >> $ENV_FILE

      - name: üßë‚Äçüíª Decode google services
        run: pnpm run decode-google-services

      - name: üì¶ Set Up JDK
        uses: ./.github/actions/setup-jdk-generate-apk
        with:
          APP_ENV: development

      - name: ‚è±Ô∏è EAS Build Android
        uses: ./.github/actions/eas-build
        with:
          APP_ENV: development
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN_XRAY_ANALYZER }}
          VERSION: ${{ env.PACKAGE_VERSION }}
          FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS }}
          FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          CREDENTIAL_FILE_CONTENT_GOOGLE_KEY: ${{ secrets.FIREBASE_DISTRIBUTION_CREDENTIAL_FILE_CONTENT}}
          ANDROID: true
          IOS: false
          SHOULD_SUBMIT: ${{ needs.setup.outputs.should_submit }}

  # Build:
  #   name: EAS Development Build (Android & IOS) (EAS)
  #   runs-on: ubuntu-latest
  #   environment: development
  #   steps:
  #     - name: Check for EXPO_TOKEN
  #       run: |
  #         if [ -z "${{ secrets.EXPO_TOKEN_XRAY_ANALYZER }}" ]; then
  #           echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
  #           exit 1
  #         fi
  #     - name: üì¶ Checkout project repo
  #       uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0

  #     - name: üì¶ Setup Node + PNPM + install deps
  #       uses: ./.github/actions/setup-node-pnpm-install

  #     - name: Get version from package.json
  #       id: get_version
  #       run: |
  #         # Use Node.js to extract the version
  #         VERSION=$(node -p "require('./package.json').version")
  #         # Set the version as an environment variable for later steps
  #         echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

  #     - name: Set Build Variables
  #       id: set_build_vars
  #       run: |
  #         if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
  #           echo "RUN_IOS=${{ github.event.client_payload.run_ios }}" >> $GITHUB_ENV
  #           echo "RUN_ANDROID=${{ github.event.client_payload.run_android }}" >> $GITHUB_ENV
  #           echo "SHOULD_SUBMIT=${{ github.event.client_payload.should_submit }}" >> $GITHUB_ENV
  #         else
  #           echo "RUN_IOS=false" >> $GITHUB_ENV
  #           echo "RUN_ANDROID=true" >> $GITHUB_ENV
  #           echo "SHOULD_SUBMIT=false" >> $GITHUB_ENV
  #         fi

  #     - name: 'Load environment variables'
  #       run: |
  #         # Define the environment file name based on the input environment
  #         APP_ENV="development"
  #         ENV_FILE=".env.${APP_ENV}"

  #         # Create the environment file (use $ENV_FILE variable)
  #         touch $ENV_FILE

  #         # Export Google Services JSON secrets to the GitHub environment
  #         echo "GOOGLE_SERVICES_JSON_ANDROID_BASE64=${{ secrets.GOOGLE_SERVICES_JSON_ANDROID_BASE64 }}" >> $GITHUB_ENV
  #         echo "GOOGLE_SERVICES_PLIST_IOS_BASE64=${{ secrets.GOOGLE_SERVICES_PLIST_IOS_BASE64 }}" >> $GITHUB_ENV

  #         # Append environment variables to the defined env file
  #         echo "GOOGLE_SERVICES_JSON_PATH=${{ vars.GOOGLE_SERVICES_JSON_PATH }}" >> $ENV_FILE
  #         echo "GOOGLE_SERVICES_PLIST_PATH=${{ vars.GOOGLE_SERVICES_PLIST_PATH }}" >> $ENV_FILE
  #         echo "ANTHROPIC_API_KEY=${{secrets.ANTHROPIC_API_KEY}}" >> $ENV_FILE
  #         echo "RESEND_API_KEY=${{secrets.RESEND_API_KEY}}" >> $ENV_FILE
  #         echo "RESEND_SENDER_EMAIL=${{secrets.RESEND_SENDER_EMAIL}}" >> $ENV_FILE
  #         echo "RESEND_SENDER_EMAIL=${{secrets.TEST_ACCOUNT}}" >> $ENV_FILE

  #     - name: üßë‚Äçüíª Decode google services
  #       run: |
  #         echo "Run decode services command"
  #         pnpm run decode-google-services

  #     - name: üì¶ Set Up JDK
  #       uses: ./.github/actions/setup-jdk-generate-apk
  #       with:
  #         APP_ENV: development

  #     - name: ‚è±Ô∏è EAS Build
  #       uses: ./.github/actions/eas-build
  #       with:
  #         APP_ENV: development
  #         EXPO_TOKEN: ${{ secrets.EXPO_TOKEN_XRAY_ANALYZER }}
  #         VERSION: ${{ env.PACKAGE_VERSION }}
  #         FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS }}
  #         FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
  #         CREDENTIAL_FILE_CONTENT_GOOGLE_KEY: ${{ secrets.FIREBASE_DISTRIBUTION_CREDENTIAL_FILE_CONTENT}}
  #         IOS: false # TODO: set as true when IOS account is ready
